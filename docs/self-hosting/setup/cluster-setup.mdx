---
title: "Cluster Setup"
description: "How to set up Formbricks in a High-Availability Cluster"
icon: "circle-nodes"
---

## Overview

Running Formbricks as a cluster of multiple instances offers several key advantages:

- **High Availability**: Ensure your surveys remain accessible even if some instances fail

- **Load Distribution**: Handle higher traffic by distributing requests across multiple instances

- **Scalability**: Easily scale horizontally by adding more instances as your needs grow

- **Zero-Downtime Updates**: Rolling updates without service interruption

## Requirements

To run Formbricks in a cluster setup, you'll need:

- Shared PostgreSQL database

- Shared Redis/Valkey cache for session management, rate limiting, caching, and audit logging

- S3-compatible storage (AWS S3, MinIO, etc.) for shared file uploads across all instances

- Load balancer to distribute traffic

<Note>
  Formbricks supports Valkey as a Redis-compatible alternative. The application uses the `REDIS_URL` environment variable regardless of whether you use Redis or Valkey.
</Note>

## Architecture

The Formbricks cluster setup consists of multiple components working together to provide a scalable and highly available system. Here's a detailed overview of the architecture:

```mermaid
graph TD
    subgraph Load Balancer
        LB[Load Balancer/Ingress]
    end

    subgraph Formbricks Cluster
        FB1[Formbricks Instance 1]
        FB2[Formbricks Instance 2]
        FB3[Formbricks Instance n]
    end

    subgraph Data Storage
        subgraph PostgreSQL HA
            PSQL_P[(PostgreSQL Primary)]
            PSQL_R[(PostgreSQL Replica)]
        end

        subgraph Redis/Valkey Cluster
            RC_P[(Redis/Valkey Primary)]
            RC_R[(Redis/Valkey Replica)]
        end

        S3[S3 Compatible Storage]
    end

    %% Connections
    LB --> FB1
    LB --> FB2
    LB --> FB3

    FB1 --> PSQL_P
    FB2 --> PSQL_P
    FB3 --> PSQL_P
    PSQL_P --> PSQL_R

    FB1 --> RC_P
    FB2 --> RC_P
    FB3 --> RC_P
    RC_P --> RC_R

    FB1 --> S3
    FB2 --> S3
    FB3 --> S3

    style PSQL_P fill:#00C4B8,color:#ffffff
    style PSQL_R fill:#00C4B8,color:#ffffff
    style RC_P fill:#FF6B6B,color:#ffffff
    style RC_R fill:#FF6B6B,color:#ffffff
    style S3 fill:#FFA94D,color:#ffffff
    style FB1,FB2,FB3 fill:#0D9373,color:#ffffff
    style LB fill:#4C6EF5,color:#ffffff
```

### Component Description

1. **Formbricks Cluster**

   - Multiple Formbricks instances (1..n) running in parallel
   - Each instance is stateless and can handle any incoming request
   - Automatic failover if any instance becomes unavailable

2. **PostgreSQL Database**

   - Primary database storing all survey, response, and contact data
   - Uses `pgvector/pgvector:pg17` image with vector search capability
   - Optional high-availability setup with primary-replica configuration
   - Handles all persistent data storage needs

3. **Redis/Valkey Cluster**

   - Acts as a distributed cache and session layer. Valkey is an open-source, Redis-compatible alternative fully supported by Formbricks
   - Handles session management, rate limiting, caching, and audit logging
   - Improves performance by caching frequently accessed data
   - Can be configured in HA mode with primary-replica setup
   - Formbricks requires Redis/Valkey to start. The application will not function without a configured `REDIS_URL`

4. **S3 Compatible Storage**

   - Stores file uploads and attachments
   - Can be any S3-compatible storage service (AWS S3, MinIO, etc.)
   - Provides reliable and scalable file storage
   - Regular uploads support up to 10MB, organization file storage up to 1GB (enterprise plans)

5. **Load Balancer**
   - Distributes incoming traffic across all Formbricks instances
   - Performs health checks and removes unhealthy instances
   - Ensures even load distribution and high availability

## Redis/Valkey Configuration

<Note>
  Redis/Valkey is required for Formbricks to function. The application will not start without a Redis URL configured.
</Note>

Configure Redis/Valkey by adding the following **required** environment variable to your instances:

```env
# Redis
REDIS_URL=redis://your-redis-host:6379
```

For Valkey, the same `REDIS_URL` format applies:

```env
# Valkey Cluster mode
REDIS_URL=redis://your-valkey-host:6379
```

## S3 Configuration

Configure S3 storage by adding the following environment variables to your instances:

```sh env
# Required for file uploads in serverless environments
S3_ACCESS_KEY=your-access-key
S3_SECRET_KEY=your-secret-key
S3_REGION=your-region
S3_BUCKET_NAME=your-bucket-name

# For S3-compatible storage (e.g., StorJ, MinIO)
# Leave empty for Amazon S3
S3_ENDPOINT_URL=https://your-s3-compatible-endpoint

# Enable for S3-compatible storage that requires path style
# 0 for disabled, 1 for enabled
S3_FORCE_PATH_STYLE=0
```

When using S3 in a cluster setup, ensure that:

- All Formbricks instances have access to the same S3 bucket
- The bucket has appropriate CORS settings configured
- IAM roles/users have sufficient permissions for read/write operations

## Kubernetes Setup

Formbricks provides an official Helm chart for deploying the entire cluster stack on Kubernetes. The Helm chart is available in the [Formbricks GitHub repository](https://github.com/formbricks/formbricks/tree/main/charts/formbricks).

### Features of the Helm Chart

The Helm chart provides a complete deployment solution that includes:

- Formbricks application with configurable replicas
- PostgreSQL database (with optional HA configuration)
- Redis/Valkey cluster for caching
- Optional Traefik ingress controller for routing and SSL termination
- Automatic configuration of dependencies and networking

### Installation Steps

Install the chart from the OCI registry:

```sh
helm install formbricks oci://ghcr.io/formbricks/helm-charts/formbricks -n formbricks --create-namespace
```

<Note>
  Starting from version 3.5.0, the Helm chart is available on the GitHub Container Registry (GHCR). Use `--version` flag to pin a specific version.
</Note>

### Configuration Options

The Helm chart can be customized using a `values.yaml` file to configure:

- Number of Formbricks replicas
- Resource limits and requests
- Database configuration
- Redis/Valkey settings
- Ingress rules and TLS
- Environment variables and secrets
- ServiceMonitor for Prometheus metrics
- Database migration job configuration
- External Secrets integration

Refer to the [Helm chart documentation](https://github.com/formbricks/formbricks/tree/main/charts/formbricks) for detailed configuration options and examples.

## Session Persistence

<Warning>
  All Formbricks instances in a cluster must share critical secrets and connections to function correctly. Failure to do so will result in session invalidation and data inconsistencies.
</Warning>

When running Formbricks in a cluster, ensure:

- All instances share the same `NEXTAUTH_SECRET` for session cookie validation
- All instances connect to the same Redis/Valkey instance for session storage
- All instances use the same `ENCRYPTION_KEY` for consistent encryption/decryption

## Recommended Production Configuration

The following environment variables must be identical across all Formbricks instances in the cluster:

```env
# Required for all instances
WEBAPP_URL=https://formbricks.example.com
NEXTAUTH_URL=https://formbricks.example.com
NEXTAUTH_SECRET=<shared-secret-across-all-instances>
ENCRYPTION_KEY=<shared-key-across-all-instances>
CRON_SECRET=<shared-secret>

# Shared PostgreSQL
DATABASE_URL=postgresql://user:password@postgres-primary:5432/formbricks

# Shared Redis/Valkey
REDIS_URL=redis://valkey-primary:6379

# Shared S3 Storage
S3_ACCESS_KEY=your-access-key
S3_SECRET_KEY=your-secret-key
S3_REGION=us-east-1
S3_BUCKET_NAME=formbricks
S3_ENDPOINT_URL=https://s3.amazonaws.com
```

<Note>
  All Formbricks instances in the cluster must share the same environment variable values for `NEXTAUTH_SECRET`, `ENCRYPTION_KEY`, `DATABASE_URL`, and `REDIS_URL`.
</Note>
